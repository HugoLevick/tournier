<script>
  let params = new URL(document.location).searchParams;
  const code = params.get('code');
  const error = params.get('error');
  let token, redirecting;

  if (error) {
    window.location = '/?error=Authentication canceled';
  }

  async function getToken() {
    try {
      token = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ code }),
      }).then(async (response) => {
        const data = await response.json();
        if (!response.ok) {
          redirecting = true;
          console.log(1);
          window.location = `/?error=Authentication failed (${data.message})`;
        } else return data.token;
      });

      if (!redirecting) {
        if (token) await localStorage.setItem('JWT', token);
        window.location = '/';
      }
    } catch (error) {
      window.location = '/?error=Authentication failed (App error)';
    }
  }

  getToken();
</script>
