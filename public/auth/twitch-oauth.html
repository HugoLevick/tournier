<script>
  let params = new URL(document.location).searchParams;
  const code = params.get('code');
  const error = params.get('error');
  let token;
  if (error) {
    window.location = '/?error=Authentication canceled';
  }

  console.log(JSON.stringify({ code }));
  async function getToken() {
    try {
      token = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ code }),
      })
        .then((response) => {
          if (response.status !== 201)
            window.location = '/?error=Authentication failed';
          else return response.json();
        })
        .then((object) => object.token);

      await localStorage.setItem('JWT', token);
      window.location = '/';
    } catch (error) {
      window.location = '/?error=Authentication failed';
    }
  }

  getToken();
</script>
